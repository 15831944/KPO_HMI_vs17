//## Copyright (C) 2013 SMS Siemag AG, Germany 
//## Version generated by DBClassCodeUtility BETA 0.6.3 
//## ALL METHODS MARKED AS - //##DBClassCodeUtility - WILL BE OVERWRITTEN, IF DB CLASS RE-GENERATED 
//## MANUALLY IMPLEMENTED METHODS MUST BE LOCATED BELOW THE MARK - "YOUR-CODE" - 


#include "CPDH_HM_DATA_PHASE.h"


//##DBClassCodeUtility ! DO NOT EDIT !
const std::string CPDH_HM_DATA_PHASE::HM_ID("HM_ID");
//##DBClassCodeUtility ! DO NOT EDIT !
const std::string CPDH_HM_DATA_PHASE::TREATID("TREATID");
//##DBClassCodeUtility ! DO NOT EDIT !
const std::string CPDH_HM_DATA_PHASE::PLANT("PLANT");
//##DBClassCodeUtility ! DO NOT EDIT !
const std::string CPDH_HM_DATA_PHASE::PHASE("PHASE");
//##DBClassCodeUtility ! DO NOT EDIT !
const std::string CPDH_HM_DATA_PHASE::START_TIME("START_TIME");
//##DBClassCodeUtility ! DO NOT EDIT !
const std::string CPDH_HM_DATA_PHASE::END_TIME("END_TIME");
//##DBClassCodeUtility ! DO NOT EDIT !
const std::string CPDH_HM_DATA_PHASE::DURATION("DURATION");
//##DBClassCodeUtility ! DO NOT EDIT !
const std::string CPDH_HM_DATA_PHASE::CONS_CARBIDE("CONS_CARBIDE");
//##DBClassCodeUtility ! DO NOT EDIT !
const std::string CPDH_HM_DATA_PHASE::CONS_LIME("CONS_LIME");
//##DBClassCodeUtility ! DO NOT EDIT !
const std::string CPDH_HM_DATA_PHASE::CONS_MG("CONS_MG");

//##DBClassCodeUtility ! DO NOT EDIT !
CPDH_HM_DATA_PHASE::CPDH_HM_DATA_PHASE(cCBS_StdConnection* Connection)
:CSMC_DBData("PDH_HM_DATA_PHASE",Connection)
{
  //please implement virtual method, to initialize your members  
  doOnConstruct(); 
}

//##DBClassCodeUtility ! DO NOT EDIT !
CPDH_HM_DATA_PHASE::CPDH_HM_DATA_PHASE(cCBS_Connection* Connection)
:CSMC_DBData("PDH_HM_DATA_PHASE",Connection)
{
  //please implement virtual method, to initialize your members  
  doOnConstruct(); 
}

//##DBClassCodeUtility ! DO NOT EDIT !
CPDH_HM_DATA_PHASE::CPDH_HM_DATA_PHASE()
:CSMC_DBData("PDH_HM_DATA_PHASE")
{
  //please implement virtual method, to initialize your members  
  doOnConstruct(); 
}

//##DBClassCodeUtility ! DO NOT EDIT !
CPDH_HM_DATA_PHASE::~CPDH_HM_DATA_PHASE()
{
  //please implement virtual method, to destruct your members
  doOnDestruct(); 
}

//##DBClassCodeUtility ! DO NOT EDIT !
std::string CPDH_HM_DATA_PHASE::getHM_ID(long Row)
{
  return getString(CPDH_HM_DATA_PHASE::HM_ID, Row);
}

//##DBClassCodeUtility ! DO NOT EDIT !
void CPDH_HM_DATA_PHASE::setHM_ID(const std::string& value)
{
  setString(CPDH_HM_DATA_PHASE::HM_ID, value);
}

//##DBClassCodeUtility ! DO NOT EDIT !
std::string CPDH_HM_DATA_PHASE::getTREATID(long Row)
{
  return getString(CPDH_HM_DATA_PHASE::TREATID, Row);
}

//##DBClassCodeUtility ! DO NOT EDIT !
void CPDH_HM_DATA_PHASE::setTREATID(const std::string& value)
{
  setString(CPDH_HM_DATA_PHASE::TREATID, value);
}

//##DBClassCodeUtility ! DO NOT EDIT !
std::string CPDH_HM_DATA_PHASE::getPLANT(long Row)
{
  return getString(CPDH_HM_DATA_PHASE::PLANT, Row);
}

//##DBClassCodeUtility ! DO NOT EDIT !
void CPDH_HM_DATA_PHASE::setPLANT(const std::string& value)
{
  setString(CPDH_HM_DATA_PHASE::PLANT, value);
}

//##DBClassCodeUtility ! DO NOT EDIT !
std::string CPDH_HM_DATA_PHASE::getPHASE(long Row)
{
  return getString(CPDH_HM_DATA_PHASE::PHASE, Row);
}

//##DBClassCodeUtility ! DO NOT EDIT !
void CPDH_HM_DATA_PHASE::setPHASE(const std::string& value)
{
  setString(CPDH_HM_DATA_PHASE::PHASE, value);
}

//##DBClassCodeUtility ! DO NOT EDIT !
CDateTime CPDH_HM_DATA_PHASE::getSTART_TIME(long Row)
{
  CDateTime D;
  D.fromDBString(getString(CPDH_HM_DATA_PHASE::START_TIME, Row));
  return D;
}

//##DBClassCodeUtility ! DO NOT EDIT !
void CPDH_HM_DATA_PHASE::setSTART_TIME(const CDateTime& value)
{
 setString(CPDH_HM_DATA_PHASE::START_TIME, value.toDBString());
}

//##DBClassCodeUtility ! DO NOT EDIT !
CDateTime CPDH_HM_DATA_PHASE::getEND_TIME(long Row)
{
  CDateTime D;
  D.fromDBString(getString(CPDH_HM_DATA_PHASE::END_TIME, Row));
  return D;
}

//##DBClassCodeUtility ! DO NOT EDIT !
void CPDH_HM_DATA_PHASE::setEND_TIME(const CDateTime& value)
{
 setString(CPDH_HM_DATA_PHASE::END_TIME, value.toDBString());
}

//##DBClassCodeUtility ! DO NOT EDIT !
double CPDH_HM_DATA_PHASE::getDURATION(long Row)
{
  return getDouble(CPDH_HM_DATA_PHASE::DURATION, Row);
}

//##DBClassCodeUtility ! DO NOT EDIT !
void CPDH_HM_DATA_PHASE::setDURATION(double value)
{
  setDouble(CPDH_HM_DATA_PHASE::DURATION, value);
}

//##DBClassCodeUtility ! DO NOT EDIT !
double CPDH_HM_DATA_PHASE::getCONS_CARBIDE(long Row)
{
  return getDouble(CPDH_HM_DATA_PHASE::CONS_CARBIDE, Row);
}

//##DBClassCodeUtility ! DO NOT EDIT !
void CPDH_HM_DATA_PHASE::setCONS_CARBIDE(double value)
{
  setDouble(CPDH_HM_DATA_PHASE::CONS_CARBIDE, value);
}

//##DBClassCodeUtility ! DO NOT EDIT !
double CPDH_HM_DATA_PHASE::getCONS_LIME(long Row)
{
  return getDouble(CPDH_HM_DATA_PHASE::CONS_LIME, Row);
}

//##DBClassCodeUtility ! DO NOT EDIT !
void CPDH_HM_DATA_PHASE::setCONS_LIME(double value)
{
  setDouble(CPDH_HM_DATA_PHASE::CONS_LIME, value);
}

//##DBClassCodeUtility ! DO NOT EDIT !
double CPDH_HM_DATA_PHASE::getCONS_MG(long Row)
{
  return getDouble(CPDH_HM_DATA_PHASE::CONS_MG, Row);
}

//##DBClassCodeUtility ! DO NOT EDIT !
void CPDH_HM_DATA_PHASE::setCONS_MG(double value)
{
  setDouble(CPDH_HM_DATA_PHASE::CONS_MG, value);
}

//##DBClassCodeUtility ! DO NOT EDIT !
bool CPDH_HM_DATA_PHASE::select(const std::string& HM_ID, const std::string& TREATID, const std::string& PLANT, const std::string& PHASE, const CDateTime& START_TIME)
{
  cleanWhereStatement();

  m_Statement = "Select * from " + m_TableName;

  addWhereClause(CPDH_HM_DATA_PHASE::HM_ID,HM_ID);
  addWhereClause(CPDH_HM_DATA_PHASE::TREATID,TREATID);
  addWhereClause(CPDH_HM_DATA_PHASE::PLANT,PLANT);
  addWhereClause(CPDH_HM_DATA_PHASE::PHASE,PHASE);
  addWhereClause(CPDH_HM_DATA_PHASE::START_TIME,START_TIME);
  m_Statement += getWhereStatement() + ";";

  return CSMC_DBData::select();
}

//## ------------------------------------END-GENERATED-CODE---------------------- 

//## ------------------------------------YOUR-CODE------------------------------- 

bool CPDH_HM_DATA_PHASE::selectOpenPhase(const std::string& HM_ID, const std::string& TREATID, const std::string& PLANT)
{
  cleanWhereStatement();

  m_Statement = "Select * from " + m_TableName;

  addWhereClause(CPDH_HM_DATA_PHASE::HM_ID,HM_ID);
  addWhereClause(CPDH_HM_DATA_PHASE::TREATID,TREATID);
  addWhereClause(CPDH_HM_DATA_PHASE::PLANT,PLANT);
	addWhereClause(CPDH_HM_DATA_PHASE::START_TIME + " is not NULL");
	addWhereClause(CPDH_HM_DATA_PHASE::END_TIME + " is NULL");

  m_Statement += getWhereStatement() + " order by START_TIME desc;";


  return CSMC_DBData::select();
}

bool CPDH_HM_DATA_PHASE::closeOpenPhase(const std::string& pHMId, const std::string& pTreatID, const std::string& pPlant, const std::string& PhaseName, const CDateTime& START_TIME,
                                        double CONS_CARBIDE, double CONS_LIME, double CONS_MG, bool Commit, cCBS_ODBC_DBError &Error)
{
	bool result=true;
  CDateTime now;

  if ( select( pHMId, pTreatID, pPlant, PhaseName, START_TIME) )
  {
    CDeltaTime DiffTime = CDateTime::subTimes( now, START_TIME );

    setDURATION( DiffTime.asSeconds() / 60 );
    setEND_TIME( now );

    // Set the consmption only if the caller has given any value.
    // If the caller does not no any value, keep the old one (mostly zero)
    if ( CONS_CARBIDE != CSMC_DBData::unspecDouble )
    {
      setCONS_CARBIDE( CONS_CARBIDE );
    }
    if ( CONS_LIME != CSMC_DBData::unspecDouble )
    {
      setCONS_LIME( CONS_LIME );
    }
    if ( CONS_MG != CSMC_DBData::unspecDouble )
    {
      setCONS_MG( CONS_MG );
    }

    result = update();
	  if (!result)
		  Error = getLastError();

	  if(Commit)
	  {
		  if (result)
			  this->commit();
		  else
			  rollback();
	  }
  }
	return result;
}

bool CPDH_HM_DATA_PHASE::InsertNewPhase(const std::string& pHMId, const std::string& pTreatID, const std::string& pPlant, const std::string& PhaseName, bool Commit, cCBS_ODBC_DBError &Error)
{
	bool result=true;
	CDateTime now;
  std::stringstream sql;
	std::stringstream sqlstr;

  setHM_ID(pHMId);
	setTREATID(pTreatID);
	setPLANT(pPlant);
	setPHASE(PhaseName);
	setSTART_TIME(now);
	setDURATION(0);
	setCONS_CARBIDE(0);
	setCONS_LIME(0);
	setCONS_MG(0);

	result = insert();
	if (!result)
		Error = getLastError();

	if(Commit)
	{
		if (result)
			this->commit();
		else
			rollback();
	}

	return result;
}


bool CPDH_HM_DATA_PHASE::doPhaseDataChange(const string& pHMId, const string& pTreatID, const string& pPlant, const string& pPhase, double pDuration, double pConsCarbide, double pConsMG, double pConsLime, bool pCommit)
{
	bool result=true;
	CDateTime now;
  std::stringstream sql;
	std::stringstream sqlstr;
	try
	{
		if(pPhase.compare("HMD_PHASE_PREPARATION")!=0)
		{
			//sql << "update PDH_HM_DATA_PHASE set "
			//	  << "END_TIME  = '" << now.toDBString() << "'" //, "	
			//		//<< "CONS_MG  = (select CONS_MG  from PDH_CYCL_MEAS_DATA   where REVTIME =(select max(REVTIME) from PDH_CYCL_MEAS_DATA)), "	
			//		//<< "CONS_CARBIDE  = (select CONS_CARBIDE  from PDH_CYCL_MEAS_DATA   where REVTIME =(select max(REVTIME) from PDH_CYCL_MEAS_DATA))"
			//		<< " where END_TIME IS NULL "
			//		<< "and HM_ID = '" << pHMId << "' and TREATID = '" << pTreatID << "' and PLANT = '" << pPlant << "'"  ; 
			//SANKAR
			sql << "update PDH_HM_DATA_PHASE set "
				  << "END_TIME  = '" << now.toDBString() << "' ," 	
					<< "CONS_MG  = " << pConsMG	<< " ," 	
					<< "CONS_CARBIDE  = " << pConsCarbide << " ," 	
					<< "CONS_LIME  = " << pConsLime  	<< " ," 	
					<< "DURATION  = " << pDuration  	
					<< " where END_TIME IS NULL "
					<< "and HM_ID = '" << pHMId << "' and TREATID = '" << pTreatID << "' and PLANT = '" << pPlant << "'"  ; 

			result = executeSQL(sql.str());
			if (pCommit)
			{
				if (result)
				{
					commit();
				}
				else
				{
					rollback();
				}
			}
		}

	//sqlstr << "insert into PDH_HM_DATA_PHASE(HM_ID,TREATID,PLANT,PHASE,START_TIME,DURATION,CONS_MG,CONS_CARBIDE, CONS_LIME) " 
	//		<< "values('" << pHMId << "','" << pTreatID << "','" << pPlant << "','" << pPhase <<  "','" << now.toDBString() << "' ,"  << pDuration  <<	"," << pConsMG << ","  << pConsCarbide << ","  << pConsLime << ")";	

  //SANKAR
	sqlstr << "insert into PDH_HM_DATA_PHASE(HM_ID,TREATID,PLANT,PHASE,START_TIME) " 
			<< "values('" << pHMId << "','" << pTreatID << "','" << pPlant << "','" << pPhase <<  "','" << now.toDBString() << "')";	

	result = result && executeSQL(sqlstr.str());
	if (pCommit)
	{
		if (result)
		{
			commit();
		}
		else
		{
			rollback();
		}
	}
	}
	catch(...)
	{
		result=false;
		log("ERROR: PDH_HM_DATA_PHASE::doPhaseDataChange failed",1);
	}

	return result;
}

bool CPDH_HM_DATA_PHASE::doBlowEnd(const string& pHMId, const string& pTreatID, const string& pPlant, double pDuration, double pConsCarbide, double pConsMG, double pConsLime, bool pCommit)
{
	bool result=true;
	CDateTime now;
  std::stringstream sql;
	std::stringstream sqlstr;
	try
	{
			sql << "update PDH_HM_DATA_PHASE set "
				  << "END_TIME  = '" << now.toDBString() << "' ," 	
					<< "CONS_MG  = " << pConsMG	<< " ," 	
					<< "CONS_CARBIDE  = " << pConsCarbide << " ," 	
					<< "CONS_LIME  = " << pConsLime  	<< " ," 	
					<< "DURATION  = " << pDuration  	
					<< " where END_TIME IS NULL "
					<< "and HM_ID = '" << pHMId << "' and TREATID = '" << pTreatID << "' and PLANT = '" << pPlant << "'"  ; 

			result = executeSQL(sql.str());
			if (pCommit)
			{
				if (result)
				{
					commit();
				}
				else
				{
					rollback();
				}
			}
		
	}
	catch(...)
	{
		result=false;
		log("ERROR: PDH_HM_DATA_PHASE::doBlowEnd failed",1);
	}

	return result;
}

bool CPDH_HM_DATA_PHASE::insert_PDH_HM_DATA_PHASE(const string& pHMId, const string& pTreatID, const string& pPlant, bool pCommit)
{
	bool result=true;
	CDateTime now;
  std::stringstream sql;
	std::stringstream sqlstr;
	try
	{
		setHM_ID(pHMId);
		setTREATID(pTreatID);
		setPLANT(pPlant);
		//setPHASE("HMD_PHASE_PREPARATION");
		setPHASE("MONO_INJECTION_CARBIDE_START");
		setSTART_TIME(now.toDBString());
		setDURATION(0);
		setCONS_CARBIDE(0);
		setCONS_LIME(0);
		setCONS_MG(0);

	result = insert();
	if (pCommit)
	{
		if (result)
		{
			commit();
		}
		else
		{
			rollback();
		}
	}
	}
	catch(...)
	{
		result=false;
		log("ERROR: PDH_HM_DATA_PHASE::doPhaseDataChange failed",1);
	}

	return result;
}

bool CPDH_HM_DATA_PHASE::update_AfterHeatDeparture(const string& pHMId, const string& pTreatID, const string& pPlant, bool pCommit)
{
	bool result=true;
	CDateTime now;
  std::stringstream sql;
	try
	{
			sql << "update PDH_HM_DATA_PHASE set "
				<< "END_TIME  = '" << now.toDBString() << "' "	
				<< "where END_TIME IS NULL "
				<< "and HM_ID = '" << pHMId << "' and TREATID = '" << pTreatID << "' and PLANT = '" << pPlant << "'"  ; 

			result = executeSQL(sql.str());
			if (pCommit)
			{
				if (result)
				{
					commit();
				}
				else
				{
					rollback();
				}
			}
		}

	catch(...)
	{
		result=false;
		log("ERROR: CPDH_HM_DATA_PHASE::update_AfterHeatDeparture failed",1);
	}

	return result;
}

bool CPDH_HM_DATA_PHASE::select_phase(const std::string& HM_ID, const std::string& TREATID, const std::string& PLANT)
{
  cleanWhereStatement();

  m_Statement = "Select * from PDH_HM_DATA_PHASE where " ;
	m_Statement = m_Statement + "HM_ID  = '" + HM_ID + "' and " ;
	m_Statement = m_Statement + "TREATID  = '" + TREATID + "' and " ;
	m_Statement = m_Statement + "PLANT  = '" + PLANT + "' order by START_TIME desc" ;

  return CSMC_DBData::select();
}
bool CPDH_HM_DATA_PHASE::select_phaseDur(const std::string& HM_ID)
{
  cleanWhereStatement();

  m_Statement = "select t1.start_time as START_TIME, t2.end_time as END_TIME, (case when t2.END_TIME is null then date_comparison_in_min(dateToString(sysdate,':'), t1.start_time)  else date_comparison_in_min(t2.end_time, t1.start_time) end) as DURATION from " ;
	m_Statement = m_Statement + "(select START_TIME, hm_id as HM_ID from PDH_HM_DATA_PHASE where start_time = (select min(start_time) from pdh_hm_data_phase where hm_id = '" + HM_ID + "')) t1,";
	m_Statement = m_Statement + "(select END_TIME, hm_id as HM_ID from PDH_HM_DATA_PHASE where start_time = (select max(start_time) from pdh_hm_data_phase where hm_id = '" + HM_ID + "') and  phase = 'MONO_INJECTION_CARBIDE_END') t2 ";
	m_Statement = m_Statement + "where t1.hm_id = t2.hm_id" ;

  return CSMC_DBData::select();
}


